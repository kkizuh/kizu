# Контейнеры vs ВМ — в чём разница

## Идея в одном абзаце

- **ВМ (виртуалки)** — каждая копирует целую ОС поверх гипервизора. Тяжелее, изолированнее, стартуют дольше, больше оверхед I/O/памяти.
- **Контейнеры** — процессы на одном ядре/ядре хоста, изоляция через **namespaces** + **cgroups**, упаковка зависимостей в образ. Легче, стартуют моментально, но делят ядро → другие риски и ограничения.

---

## Архитектура (упрощённо)

|Слой|ВМ (KVM/VMware/Hyper-V)|Контейнеры (Docker/CRI)|
|---|---|---|
|Апп/библиотеки|Приложение внутри гостевой ОС|Приложение + рантайм/библиотеки|
|Гостевая ОС|**Да** (каждая ВМ: свой kernel+userspace)|**Нет** (используют kernel хоста)|
|Виртуализация|Гипервизор (type-1/2)|Контейнерный рантайм (runc, containerd)|
|Ядро|Отдельное в каждой ВМ|**Общее ядро** хоста|
|Изоляция|Аппаратная (VT-x/AMD-V, EPT/NPT)|OS-уровень (namespaces/cgroups/LSM)|

---

## Что это даёт на практике

|Критерий|Контейнеры|ВМ|
|---|---|---|
|**Старт**|~0.1–2 сек|~10–120 сек|
|**Оверхед**|Низкий (общий kernel)|Выше (полная гостевая ОС)|
|**Плотность**|Высокая (десятки–сотни на хост)|Ниже (штук несколько–десяток)|
|**Изоляция**|ОС-уровень, сильная но не «железная»|Почти как “железо”, жёсткая граница|
|**Кросс-ядро/дистро**|Ограничено (зависят от ядра хоста)|Любая ОС внутри|
|**Безопасность**|Хорошая с правильным hardening|Сильная по умолчанию|
|**Состояние**|Эфемерные по идее, state выносят в тома|Часто stateful (диски ВМ)|
|**Dev→Prod паритет**|Силен (образ = то же окружение)|Тяжелее (образы ВМ, конфиг дистры)|
|**Сетевой стек**|NAT/bridge/overlay контейнерной сети|Полноценный виртуальный NIC|
|**Диагностика**|Логи/метрики по процессам|Как на отдельном сервере|

---

## Где что использовать

**Контейнеры — когда:**
- микросервисы, веб-АПИ, очереди, фоновые workers, cron-задачи;
- быстрый CI/CD (immutable образы, быстрые деплои);
- экономия ресурсов и высокая плотность.

**ВМ — когда:**
- нужен **другой kernel/другая ОС** (BSD/Windows внутри Linux и наоборот);
- **жёсткая изоляция/мульти-тенант** (разные заказчики);
- требуются kernel-модули/драйверы/системные службы, несовместимые с хостом;
- «тяжёлые» stateful-монолитные системы, которым так привычнее.

**Серебряной пули нет:** часто сочетают — несколько ВМ как «стойки», внутри каждой — парк контейнеров (K8s/Swarm/Nomad).

---

## Безопасность и риски (коротко)
- Контейнер = **процесс**. Убеждайся, что он **не root** (`USER 10001`), rootless Docker/Podman, drop capabilities, Seccomp/AppArmor/SELinux, read-only FS.
- ВМ лучше изолирует, но дороже в ресурсах и операционно.

---

## Производительность
- CPU: почти нативно у обоих (современные гипервизоры ≈1–5% оверхеда).
- Память/диски: у ВМ выше расход (гостевая ОС), у контейнеров — дешевле.
- Сеть: контейнеры быстрее стартуют, но overlay сети добавляют latency.

---

## Тонкие моменты и мифы
- **“Контейнер = мини-ВМ”** — нет. Контейнер — это упаковка процесса с изоляцией; ядро общее.
- **“Контейнеры небезопасны”** — при грамотном hardening норм; но для жёсткого мульти-тенанта чаще берут ВМ/микровмы (Firecracker/Kata).
- **“Alpine всегда лучше”** — не всегда: musl vs glibc может ломать нативные зависимости (берегись `node-gyp`, `sharp`, Java агенты).

---

## Быстрые примеры/команды

Показать namespaces/cgroups процесса контейнера:

```bash
# PID контейнера
docker inspect --format '{{.State.Pid}}' myapp
# Посмотреть его namespaces
ls -l /proc/$(docker inspect -f '{{.State.Pid}}' myapp)/ns
```

Лимиты ресурсов (cgroups) в Docker:

```bash
docker run -d --cpus=1.0 --memory=512m --pids-limit=256 myimg:tag
```

Не root в контейнере:

```dockerfile
# в Dockerfile
RUN adduser -D -u 10001 appuser
USER 10001
```

---

## Краткий чек-лист выбора

- Нужна **другая ОС/ядро** → **ВМ**.
- Нужны **быстрые деплои/масштаб** → **контейнеры**.
- **Жёсткая изоляция** (чужие клиенты/регуляторика) → **ВМ/микро-ВМ**.
- **Смешанный** мир? Делай ВМ как «узлы» и запускай на них **Kubernetes** с контейнерами.

---

## TL;DR
- Контейнеры = **легко, быстро, дёшево**, но **делят ядро**.
- ВМ = **тяжелее, медленнее**, но **изолированнее и универсальнее**.
- В реальных продах почти всегда **гибрид**.